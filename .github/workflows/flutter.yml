name: Flutter CI/CD

on:
  push:
    branches: [ master, development ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, development ]

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  test:
    name: Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØ­Ù„ÙŠÙ„
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: flutter pub get
        
      - name: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        run: flutter analyze
        
      - name: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        run: flutter test

  build:
    name: Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    needs: test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: flutter pub get
        
      - name: Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© Windows
        run: flutter build windows --release
        
      - name: Ø¶ØºØ· Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        run: |
          cd build/windows/runner/Release
          7z a -tzip ../../../flutter_publisher_windows.zip *
        
      - name: ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Windows
        uses: actions/upload-artifact@v3
        with:
          name: windows-build
          path: build/flutter_publisher_windows.zip

  release:
    name: Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø±
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Windows
        uses: actions/download-artifact@v3
        with:
          name: windows-build
          
      - name: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        id: release_notes
        run: |
          echo "Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:" > release_notes.md
          echo "" >> release_notes.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"* %s" >> release_notes.md
          
      - name: Ù†Ø´Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø±
        uses: softprops/action-gh-release@v1
        with:
          files: flutter_publisher_windows.zip
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø´Ø±
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: 'ØªÙ… Ù†Ø´Ø± Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­! ðŸš€'
